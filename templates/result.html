{% extends "base.html" %}

{% block title %}분석 결과{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">포트폴리오 내용 확인</h1>
    <form id="portfolio-edit-form" method="POST" action="{{ url_for('save_portfolio') }}">
        {% for exp in analysis.work_experience %}
        <div class="card mb-4">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="company" value="{{ exp.company }}" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="start_date" value="{{ exp.start_date }}" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="end_date" value="{{ exp.end_date }}" required>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% for resp in exp.responsibilities %}
                <div class="mb-4 project-section">
                    <div class="form-group mb-3">
                        <label class="form-label">프로젝트명</label>
                        <input type="text" class="form-control" name="project_names[]" value="{{ resp.project }}" required>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">업무 내용</label>
                        {% for detail in resp.details %}
                        <div class="input-group mb-2">
                            <span class="input-group-text">•</span>
                            <input type="text" class="form-control" name="details[]" value="{{ detail }}" required>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">주요 성과</label>
                        {% for result in resp.results %}
                        <div class="input-group mb-2">
                            <span class="input-group-text">•</span>
                            <input type="text" class="form-control" name="results[]" value="{{ result }}" required>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <div class="text-center mb-4">
            <button type="submit" class="btn btn-primary" id="save-portfolio-btn">
                수정을 완료했어요
            </button>
            <button type="button" class="btn btn-secondary ms-2" id="download-btn">
                포트폴리오 다운로드
            </button>
        </div>
    </form>
</div>

<script>
document.getElementById('portfolio-edit-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    try {
        const response = await fetch('/save_portfolio', {
            method: 'POST',
            body: JSON.stringify(Object.fromEntries(formData)),
            headers: {
                'Content-Type': 'application/json',
            },
        });

        if (response.ok) {
            alert('수정사항이 저장되었습니다.');
        } else {
            throw new Error('저장 실패');
        }
    } catch (error) {
        alert('저장 중 오류가 발생했습니다.');
        console.error('Error:', error);
    }
});

document.getElementById('download-btn').addEventListener('click', async function() {
            try {
                const response = await fetch('/download/portfolio.pptx');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/vnd.openxmlformats-officedocument.presentationml.presentation')) {
                    throw new Error('Invalid file type received');
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'portfolio.pptx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Download error:', error);
                alert('파일 다운로드 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
            }
        });
</script>
{% endblock %}